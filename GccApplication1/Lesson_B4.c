/*
 * Lesson_B4.c
 * Дифференциальный режим АЦП
 * Измерение тока нагрузки
 * с помощью токового шунта
 * опорное напряжение от 
 * внутреннего источника U
 
 #include <avr/io.h>
 #include "lcd1602wire4.h"
 #define F_CPU 8000000
 #include <util/delay.h>
 #include <stdio.h>
 float cod,current;
 //Массив для вывода результата на дисплей
 char str[12];
 //Инициализация АЦП
 void ADC_ini(void)
 {
	 ADCSRA|=(1<<ADEN);//Включение АЦП
	 //частота АЦП = 1/64 проц. частоты
	 ADCSRA|=(1<<ADPS2)|(1<<ADPS1);
	 //Опорное напряжение берется от
	 //внутреннего источника U=2.56В;
	 ADMUX|=(1<<REFS0)|(1<<REFS1);
	 //Выбираем режим АЦП с дифференциальными входами
	 //PA3 - "+", PA2 - "-"  с усилением в 10 раз
	 ADMUX|=(1<<MUX3)|(1<<MUX2)|(1<<MUX0);
	 //Выравнивание записи результата
	 //преобразования влево
	 ADMUX|=(1<<ADLAR);
 }
 //Функция преобразования АЦП
 void ADCconvert(void)
 {
	 //Запуск одиночного преобразования
	 ADCSRA|=(1<<ADSC);
	 //Подождать, пока не завершится преобразование
	 while(ADCSRA&(1<<ADSC));
	 //Запись в переменную содержимого регистра ADC
	 cod=ADCH;
 }
 //
 int main(void)
 {
	 //Инициализация дисплея и встроенного АЦП
	 LCD_ini();
	 ADC_ini();
	 //
	 while (1)
	 {
		 //Запустить преобразование
		 ADCconvert();
		 //Преобразование кода в ток
		 current=cod*0.01;//current=(cod*2.56/256)
		 //Вывод значения тока на дисплей
		 setpos_to_LCD(0,0);
		 sprintf(str,"I=%.2f",current);
		 //Вывести массив с результатом на дисплей
		 string_to_LCD(str);
		 string_to_LCD("A  ");
	 }
 }

//ЗАДАЧА: Производите измерение тока на шунте R4 в 
//дифференциальном режиме между выводами ADC1-ADC0 мультиплексора.
//В качестве опорного напряжения используйте напряжение с вывода AVcc.
//Выводите на LCD-дисплей помимо значения измеряемого тока, также код
//с регистра ADCH и значение напряжения на шунте.
// Смоделировать в Proteus
*/

/*
* Lesson_B4.c
* Дифференциальный режим АЦП
* Измерение тока нагрузки
* с помощью токового шунта
* опорное напряжение от AVcc
*/
#include <avr/io.h>
#include "lcd1602wire4.h"
#define F_CPU 8000000
#include <util/delay.h>
#include <stdio.h>

float cod, current, voltage;
// Массив для вывода результата на дисплей
char str[16];

// Инициализация АЦП
void ADC_ini(void) {
	ADCSRA |= (1 << ADEN); // Включение АЦП
	// частота АЦП = 1/64 проц. частоты
	ADCSRA |= (1 << ADPS2) | (1 << ADPS1);
	// Опорное напряжение берется от AVcc
	ADMUX |= (1 << REFS0);
	// Выбираем режим АЦП с дифференциальными входами
	// ADC1 (PA1) - "+", ADC0 (PA0) - "-" без усиления
	ADMUX |= (1 << MUX0) | (1 << MUX2) | (1 << MUX3);
	ADMUX &=~ (1 << MUX1) &~ (1 << MUX4);
	// Выравнивание записи результата преобразования влево
	ADMUX |= (1 << ADLAR);
}

// Функция преобразования АЦП
void ADCconvert(void) {
	// Запуск одиночного преобразования
	ADCSRA |= (1 << ADSC);
	// Подождать, пока не завершится преобразование
	while (ADCSRA & (1 << ADSC));
	// Запись в переменную содержимого регистра ADC
	cod = ADCH;
}

int main(void) {
	// Инициализация дисплея и встроенного АЦП
	LCD_ini();
	ADC_ini();

	while (1) {
		// Запустить преобразование
		ADCconvert();
		// Преобразование кода в напряжение
		voltage = (cod / 256.0) * 5.0; // AVcc = 5V
		// Преобразование напряжения в ток (например, если шунт 0.1 Ом)
		current = voltage ; // Шунт = 0.1 Ом

		// Вывод значений на дисплей
		setpos_to_LCD(0, 0);
		sprintf(str, "Code=%.0f", cod);
		string_to_LCD(" ");
		string_to_LCD(str);
		setpos_to_LCD(0, 1);
		sprintf(str, "V=%.2fV I=%.2fA", voltage, current);
		string_to_LCD(str);

		_delay_ms(1000); // Задержка для обновления дисплея
	}
}

//ЗАДАЧА: Производите измерение тока на шунте R4 в
//дифференциальном режиме между выводами ADC1-ADC0 мультиплексора.
//В качестве опорного напряжения используйте напряжение с вывода AVcc.
//Выводите на
//LCD-дисплей помимо значения измеряемого тока, также код
//с регистра ADCH и значение напряжения на шунте.
// Смоделировать в Proteus




 
